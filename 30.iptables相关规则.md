# iptables相关

## 简介

```sh
iptables防火墙可以用于创建过滤与nat规则，所有linux发行版都能使用iptables。
iptables结构：iptables---->tables---->chains---->rules，简单地讲，tables有chains组成，而chains由rules组成
#概括为：四表(内建表)五链
	四表：filter、nat、mangle、raw
	五链：INPUT、OUTPUT、FORWARD、PREROUTING、POSTROUTING
```

## 链介绍

```sh
#不是所有表都有这五个链
INPUT：入站规则，从防火墙进来的数据包
OUTPUT：出站规则，从防火墙出去的数据包
FORWARD：转发规则，匹配经过防火墙主机的数据包
PREROUTING：路由前规则
POSTROUTING：路由后规则
#链里规则执行顺序
顺序匹配，匹配即停止
同类规则（访问用以应用），匹配范围小的放上面
不同类规则（访问不同应用），匹配到报文频率较大的放上面
若无任何匹配，则按照链的默认策略处理
功能的优先级次序：raw–> mangle –> nat –> filter
#针对链的可执行操作（常用操作）
-L：列出链策略
-I：在链中指定的策略前插入一条新策略
-A：在所选的链最尾部添加一条心策略
-D：删除策略
-F：清空所有链策略
-P：为链设置默认策略ACCEPT或者DROP，
	# iptables -t filter -P INPUT DROP
--line-number：显示策略序号，只与-L配合使用
	# iptables -t filter -L --line-number
-p：协议，如tcp、udp、http等
-s：ip源地址
	# -m iprange --src-range 192.168.1.10-192.168.1.100
-d：ip目标地址
	# -m iprange -dest-range 192.168.1.10-192.168.1.100
--sport：基于数据包的源端口来匹配数据包，必须与-p参数结合使用
	# 连续端口，--sport 1000:1024
	# 取反，--sport ! 1000:1024
--dport：基于数据包的目的端口来匹配数据包，必须与-p参数结合使用
-m multiport --sport：源端多端口匹配，最多15个
	# -m multiport --sport 1024,1055,1059
-i：网络接口，以数据包进入本地所使用网络接口来匹配数据包
    只能用于INPUT、FORWARD、PREROUTING这3个链
	# -i eth0
	# -i eth+  +作为通配符，这里表示所有的Ethernet接口
	# -i ！ eth0  表示除过eth0接口外的所有接口的包
-o：网路接口，以数据包离开本地所使用的网络接口来匹配数据包
    只能用于POSTROUTING、OUTPUT链中
DNAT：网络目标地址转换，就是重写数据包的目标ip地址，
      只能用于nat表的PREROUTING、OUTPUT链中，或者被这两条链调用的链中
	# --to-dest 192.168.1.10:80或者192.168.1.10:80-100
SNAT：网络源地址转换，重写数据包的源IP地址
      只能用于nat表的POSTROUTING链
	# --to-source 202.103.0.2
MASQUERADE：地址伪装，与SNAT相同，只是使用该目标时不需要知名--to-source
		   专门设计用于那些动态获取ip地址的连接（比如拨号上网）
	# --to-port 1024-5000 这里配合-p使用
ACCEPT：接受数据包
DROP：阻止数据包，不向发送者返回错误信息
REJECT：与DROP作用相同，区别在于他除了阻止数据包之外，还向发送者返回错误信息
	# iptables -A FORWARD -p tcp --dport 22 -j REDECT --reject-with tcp-reset
```

## 命令汇总

```sh
#命令格式
iptables -t $table_name	$选项	$chain_name	$条件	-j $目标操作
```

## iptables数据包

```sh
#一个数据包到达时，怎么依次穿过各个表和链
1.network
```

## 各表—链列举

### raw表

```sh
 #优先级最高，对收到数据包在连接跟踪前进行处理，处理异常，具有PREROUTING、OUTPUT两个链
 #某个链上，raw表处理完后，将跳过nat表和ip_conntrack处理，即不再做地址转换和数据包的跟踪处理
 #raw表可以应用在那些不需要做nat的情况下，以提高性能
 #例如：大量访问的web服务器，可以让80端口不再让iptables做数据包的链接跟踪处理，以提高用户访问速度
 PREROUTING Chain
 
```






























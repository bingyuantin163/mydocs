# RKE快速部署kubernetes集群

官网地址：https://rancher.com/

中文地址：https://docs.rancher.cn/

## 前期准备

### 主机准备

| address         | hostname | system    | user    | role                      |
| --------------- | -------- | --------- | ------- | ------------------------- |
| 192.168.168.131 | vm1      | CentOS7.7 | rancher | [controlplan,worker,etcd] |
| 192.168.168.132 | vm2      | CentOS7.7 | rancher | [controlplan,worker,etcd] |
| 192.168.168.133 | vm3      | CentOS7.7 | rancher | [controlplan,worker,etcd] |
| 192.168.168.134 | vm4      | CentOS7.7 | rancher | [worker]                  |

### 环境准备

#### 执行系统优化脚本

```
#也可不执行，自行优化
sh  system.sh
cat system.sh
#############################################################
# File Name: system.sh
# Author: robin
# Created Time: Fri 18 Oct 2018 05:01:02 PM CST
#==================================================================
#!/bin/sh
# 运行环境CentOS 7.x

echo "判断centos7还是centos6系统"
sleep 1
VERSION=`cat /etc/redhat-release|awk -F " " '{print $3}'|awk -F "." '{print $1}'`
if [ "$VERSION" == "6" ];then
VERSION='6'
echo "centos6"
else
VERSION='7'
echo "centos7"
fi

echo "查看内存 cpu 硬盘大小"
sleep 1
MEM=`free -m`
#4.1查看物理CPU个数
physical_id=`cat /proc/cpuinfo| grep "physical id"| sort| uniq| wc -l`
#4.2查看每个物理CPU中core的个数(即核数)
cpu_cores=`cat /proc/cpuinfo| grep "cpu cores"| uniq`
#4.3查看逻辑CPU的个数
processor=`cat /proc/cpuinfo| grep "processor"| wc -l`
echo "$MEM"
echo "####################################################"
echo "cpu物理个数 physical_id:          $physical_id"
echo "每个cpu中core的个数(即核数)       $cpu_cores"
echo "逻辑cpu的个数 processor:          $processor"
echo "####################################################"
#4.4硬盘大小
disk=`df -Th`
echo "$disk"

echo "下载wget，请稍后·······"
yum -y install wget   &>/dev/null

echo "添加DNS地址，请稍等....... "
cat >> /etc/resolv.conf << EOF
nameserver 114.114.114.114 
nameserver 114.114.114.114 
EOF

echo "是否换成阿里云的的源 "
echo "等待3秒:"
sleep 3
cat << EOF
        **********************
        1.[change aliyuan]
        2.[no change aliyuan]
        3.[exit]
    pls input the num you want:
        **********************
EOF
read -t 30 -p "pls input the num you want:" a
[ -n "`echo $a|sed 's#[0-9]##g'`" ] && {
         echo "Input error"
        exit 1
}
iffuncation(){
if [ $a -eq 1 ];then
        echo "change aliyuan"
        echo "等待3S"
        sleep 3
        mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup   &>/dev/null
        if [ "$VERSION" == "7" ];then
        wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo   &>/dev/null
        else
        wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo   &>/dev/null
        fi
        yum clean all    &>/dev/null
        yum makecache    &>/dev/null
        echo "等待3S" 
        sleep 3
elif [ $a -eq 2 ];then
        echo "no change aliyuan"
elif [ $a -eq 3 ];then
        exit 1
else
        echo "Input error"
        exit 1
fi
}
iffuncation

echo "下载必要的初始化的工具"
        sleep 3
        yum -y install net-tools tree nmap lrzsz dos2unix telnet screen vim lsof wget ntp rsync   &>/dev/null

echo "修改ip和主机名的对应关系 /etc/hosts"
        sleep 3
cat > /etc/hosts << EOF
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
EOF
if [ "$VERSION" == "7" ];then
        echo "`ifconfig|sed -n '2p'|awk -F " " '{print $2}'` $HOSTNAME" >> /etc/hosts
else
        echo "`ifconfig|sed -n '2p'|awk -F " " '{print $2}'|awk -F ":" '{print $2}'` $HOSTNAME" >> /etc/hosts
fi

echo "查看时间 并设置初始化时间"
date +%F\ %T
ntpdate cn.pool.ntp.org && hwclock -w

echo "命令补全,请稍等....... "
yum install bash-completion -y &>/dev/null

echo "/设置linux的最大文件打开数"
ulimit -SHn 65535
ulimit -a
if [ "`egrep "* - nofile 65535|* - nproc 65536" /etc/security/limits.conf|wc -l`" == "0" ];then
        echo "* - nofile 65535" >> /etc/security/limits.conf
        echo "* - nproc 65536" >> /etc/security/limits.conf
else
        echo "linux的最大文件打开数 设置成功或者之前已经设置过了"
fi
sleep 2

echo "禁用selinux,请稍等......."
sed -i 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config
setenforce 0

echo "关闭防火墙,请稍等......."
systemctl disable firewalld.service   &>/dev/null
systemctl stop firewalld.service

echo "优化ssh服务,请稍等......."
sed -i 's/^GSSAPIAuthentication yes$/GSSAPIAuthentication no/' /etc/ssh/sshd_config
sed -i 's/#UseDNS yes/UseDNS no/' /etc/ssh/sshd_config
systemctl restart sshd.service

echo "-------<内核参数优化>-------"
cat >> /etc/sysctl.conf << EOF
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.ip_forward = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
kernel.sysrq = 0
kernel.core_uses_pid = 1
net.ipv4.tcp_syncookies = 1
kernel.msgmnb = 65536
kernel.msgmax = 65536
kernel.shmmax = 68719476736
kernel.shmall = 4294967296
net.ipv4.tcp_max_tw_buckets = 6000
net.ipv4.tcp_sack = 1
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_rmem = 4096 87380 4194304
net.ipv4.tcp_wmem = 4096 16384 4194304
net.core.wmem_default = 8388608
net.core.rmem_default = 8388608
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.core.netdev_max_backlog = 262144
net.ipv4.tcp_max_orphans = 3276800
net.ipv4.tcp_max_syn_backlog = 262144
net.ipv4.tcp_timestamps = 0
net.ipv4.tcp_synack_retries = 1
net.ipv4.tcp_syn_retries = 1
net.ipv4.tcp_tw_recycle = 1
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_mem = 94500000 915000000 927000000
net.ipv4.tcp_fin_timeout = 1
net.ipv4.tcp_keepalive_time = 30
#net.ipv4.ip_local_port_range = 1024 65000
fs.file-max = 265535
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
vm.swappiness = 10

EOF
/sbin/sysctl -p
echo "系统已优化完毕，请使用！"
```

#### 开放端口

```
#通常在Kubernetes节点上打开下列端口，测试环境可以直接关闭firewalld
ansible hosts -m shell -a 'systemctl stop firewalld && systemctl status firewalld'
```

| TCP     | 22           | Node driver SSH provisioning                        |
| ------- | ------------ | --------------------------------------------------- |
| TCP     | 2376         | Node driver Docker daemon TLS port                  |
| TCP     | 2379         | etcd client requests                                |
| TCP     | 2380         | etcd peer communication                             |
| UDP     | 8472         | Canal/Flannel VXLAN overlay networking              |
| UDP     | 4789         | Flannel VXLAN overlay networking on Windows cluster |
| TCP     | 9099         | Canal/Flannel livenessProbe/readinessProbe          |
| TCP     | 6783         | Weave Port                                          |
| UDP     | 6783-6784    | Weave UDP Ports                                     |
| TCP     | 10250        | kubelet API                                         |
| TCP     | 10254        | Ingress controller livenessProbe/readinessProbe     |
| TCP/UDP | 30000- 32767 | NodePort port range                                 |

#### 关闭selinux

```
ansible hosts -m shell -a 'setenforce 0 && getenforce'
ansible hosts -m shell -a 'sed -i '/^SELINUX=/s/enforcing/disabled/' /etc/selinux/config'
```

#### 禁用swap

```
#一定要禁用swap，否则kubelet组件无法运行
ansible hosts -m shell -a 'sed -i "/swap/s/^/#/" /etc/fstab && mount -a  && swapoff -a && free -m'
```

#### 开启IPV4路由转发

```
ansible hosts -m shell -a 'sed -i "/net.ipv4.ip_forward = 0/s/net.ipv4.ip_forward = 0/net.ipv4.ip_forward = 1/" /etc/sysctl.conf  && echo "net.bridge.bridge-nf-call-ip6tables = 1" >> /etc/sysctl.conf && echo "net.bridge.bridge-nf-call-iptables = 1" >> /etc/sysctl.conf && sysctl -p'
```

#### 启用cgroup

```
ansible hosts -m shell -a 'echo GRUB_CMDLINE_LINUX_DEFAULT="cgroup_enable=memory swapaccount=1" >> /etc/default/grub && echo GRUB_CMDLINE_LINUX="cgroup_enable=memory swapaccount=1" >> /etc/default/grub'
cat >> /usr/bin/update-grub << END
#!/bin/bash
set -e
exec grub2-mkconfig -o /boot/grub2/grub.cfg "$@"
END
ansible hosts -m synchronize -a 'src=/usr/bin/update-grub  dest=/usr/bin/'
ansible hosts -m shell -a 'chmod +x /usr/bin/update-grub && update-grub'
```

### 工具准备

#### 安装RKE

```
#只需要给操作的主机安装即可,但是这里给所有主机都安装了
ansible hosts -m shell -a 'wget https://github.com/rancher/rke/releases/download/v1.0.0/rke_linux-amd64 && chmod +x rke_linux-amd64 && mv rke_linux-amd64 /usr/bin/rke'
```

#### 安装kubectl

```
ansible hosts -m shell -a 'curl -LO https://storage.googleapis.com/kubernetes-release/release/`curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt`/bin/linux/amd64/kubectl'
ansible hosts -m shell -a 'chmod +x ./kubectl && mv ./kubectl /usr/bin/ && kubectl version --client'
```

#### 安装docker

```
#按照rancher官方快速安装脚本，但是安装18.09版本（推荐）
ansible hosts -m shell -a 'curl https://releases.rancher.com/install-docker/18.09.sh | sh'
#Kubernetes1.8需要Docker 1.12.6、1.13.1、17.03，不支持更高版本的Docker
ansible hosts -m shell -a 'yum install -y yum-utils  device-mapper-persistent-data lvm2'
ansible hosts -m shell -a 'yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo'
ansible hosts -m shell -a 'yum -y install docker-ce-17.03.0.ce-1.el7.centos docker-ce-cli-17.03.0.ce-1.el7.centos containerd.io'
ansible hosts -m shell -a 'systemctl restart docker && systemctl enable docker && systemctl status docker'
```

#### 用户rancher及免密

```
#创建用户rancher
ansible hosts -m shell -a 'grep docker /etc/group && useradd -G docker rancher'
ansible hosts -m shell -a 'echo 123 | passwd --stdin rancher'
#root用户创建秘钥(131主机)
ssh-keygen -t rsa
#传输私钥（131主机）
for i in `seq 132 134`
do
ssh-copy-id -i  .ssh/id_rsa.pub  rancher@192.168.168.$i
done
```

#### 安装helm

```
#只需要在操作主机安装即可（131主机）
#官方使用3版本（推荐）
ansible hosts -m shell -a 'wget https://get.helm.sh/helm-v3.0.2-linux-amd64.tar.gz && tar -zvxf helm-v3.0.2-linux-amd64.tar.gz && mv linux-amd64/helm /usr/bin/'
```

## 创建kubernetets集群

### 创建rancher-cluster.yml文件

```
cd /home/rancher/
cat > rancher-cluster.yml << EOF
nodes: 
  - address: 192.168.168.132
    user: rancher
    role: [controlplane,worker,etcd]
  - address: 192.168.168.133
    user: rancher
    role: [controlplane,worker,etcd]
  - address: 192.168.168.134
    user: rancher
    role: [worker]
    
services:  #包括etcd、kube-api、kube-controller、scheduler、kubelete、kubeproxy
  etcd:
    snapshot: true
    creation: 6h
    retention: 24h
EOF

#说明：
	#address:生产中为公网地址
	#user:廉洁到服务器的ssh用户
	#ssh_key_pass:~/.ssh/id_rsa执行命令的私钥路径，文件中会选择默认路径
	#internal_address:内网ip
	#controlplane角色：存放运行K8s所需的Kubernetes API服务器和其他组件
					 #启动HA集群，只需controlplan指定多个主机，然后正常启动集群即可
	#RKE是一个幂等工具，可以运行多次，且每次均产生相同的输出
	例如网路插件部署（以下三个均支持）
		Calico
		Flannel (default)
		Canal
#文件中的附加选项(下面内容配置非必须写进yml文件,会采用默认方案)docker
##使用不同的网络插件，可以在配置文件中指定：
network: 
  plugin: calico
##镜像信息指定：
system_images:
  flannel: rancher/coreos-flannel:v0.11.0  #默认网络模式就为flannel
  kubedns: rancher/k8s-dns-kube-dns-amd64:1.14.5  
  dnsmasq: rancher/k8s-dns-dnsmasq-nanny-amd64:1.14.5  
  kubedns_sidecar: rancher/k8s-dns-sidecar-amd64:1.14.5  
  kubedns_autoscaler: rancher/cluster-proportional-autoscaler-amd64:1.0.0  
  dashboard: k8s.gcr.io/kubernetes-dashboard-amd64:v1.8.3
##认证模式：
authentication: 
  strategy: x509	#默认模式为x509
```

### RKE启动集群

```
rke up --config rancher-cluster.yml
```

### 设置环境变量

```
echo 'export KUBECONFIG=/home/rancher/kube_config_rancher-cluster.yml' >> /etc/profile && source /etc/profile && tail -1 /etc/profile
```

### 查看pods

```
#查看pods，有kybe-system、ingress-nginx两个命名空间的pods
kubectl get pods --all-namespaces
#此时有五个pod没有启动起来，下面四个不用管，最上面的需要重新启动
[root@vm1 ~]# kubectl get pods --all-namespaces -o wide
NAMESPACE       NAME                                      READY   STATUS              RESTARTS   AGE    IP                NODE              NOMINATED NODE   READINESS GATES
ingress-nginx   default-http-backend-67cf578fc4-nhhqj     0/1     ContainerCreating   0          108m   <none>            192.168.168.132   <none>           <none>
...
#查看原因
[root@vm1 ~]# kubectl describe pod default-http-backend-67cf578fc4-nhhqj -n ingress-nginx
...
Events:
  Type     Reason      Age                    From                      Message
  ----     ------      ----                   ----                      -------
  Warning  FailedSync  4m35s (x309 over 89m)  kubelet, 192.168.168.132  error determining status: rpc error: code = DeadlineExceeded desc = context deadline exceeded
#显示code = DeadlineExceeded
#镜像拉取时间超出了kubelet的配置参数--image-pull-progress-deadlineshe默认的一分钟导致的
#重新执行
kubectl get pod $pod_name -n ingress-nginx -o yaml | kubectl replace --force -f -
```

### 在kubernetes集群上安装rancher

#### server的SS/TLS配置

```
#rancher依靠证书管理器从rancher自己生成的CA办法证书或者请求Let's Encrypt证书
#cert-manager仅由Rancher生成的CA（ingress.tls.source=rancher）和“让我们加密已发布的证书（ingress.tls.source=letsEncrypt）”颁发的证书才需要。如果您使用自己的证书文件（选项ingress.tls.source=secret），或者在外部负载均衡器上使用TLS终止，则应跳过此步骤
kubectl apply -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.12/deploy/manifests/00-crds.yaml
kubectl create namespace cert-manager
helm repo add jetstack https://charts.jetstack.io
	如果报错提示执行helm init 或者 helm init --client-only
	再执行 helm repo add jetstack https://charts.jetstack.io 
helm install   cert-manager jetstack/cert-manager   --namespace cert-manager   --version v0.12.0
kubectl get pods --namespace cert-manager
```

#### 添加helm图表库(包含下载rancher的图表)

```
#测试可以使用最新版本(推荐)
helm repo add rancher-latest https://releases.rancher.com/server-charts/latest
#生产推荐使用稳定版
helm repo add rancher-stable https://releases.rancher.com/server-charts/stable
```

#### 为rancher创建一个namespace

```
#为rancher创建命名空间
kubectl create namespace cattle-system
```

#### rancher创建rancher

```
helm install rancher rancher-latest/rancher   --namespace cattle-system   --set hostname=vm-rancher.com
#报错Error: failed to download "rancher-stable/rancher" (hint: running `helm repo update` may help)
#按照报错提示运行
helm repo update  #运行无报错，但是创建rancher继续报错

#尝试helm的稳定版rancher图表，再部署rancher成功
helm repo add rancher-latest https://releases.rancher.com/server-charts/stable

访问
https://vm-rancher.com/
```

### 添加或删除节点

```
#RKE支持为角色为worker和controlplane的主机添加或删除节点
添加节点：
	更新具有其他节点的集群配置文件，并使用相同的文件运行集群配置即可
删除节点：
	从集群配置文件中的节点列表中删除它们，然后重新运行rke up命令
```

### 删除集群

```
#RKE支持rke remove命令，这个命令是不可逆的，它将彻底摧毁Kubernetes集群
	连接到每个主机并删除部署在其上的Kubernetes服务
	从服务所在的目录中清除每个主机：
		/etc/kubernetes/ssl
		/var/lib/etcd
		/etc/cni
		/opt/cni
```
##### 建立zabbix的Telegram报警机制

国外zabbix配置zabbix-in-Telegram，国内推荐使用钉钉，微信，QQ

1.申请Telegram机器人

申请机器人参考地址：

```
https://core.telegram.org/bots#creating-a-new-bot
```

1.1访问https://telegram.me/botfather，使用**/newbot**命令创建bot

1.2将生成的bot加入需要被告警的Tel群组，输入一些文本，稍后获取信息

1.3然后访问 [https://api.telegram.org/botXXX:YYY/getUpdates](https://links.jianshu.com/go?to=https%3A%2F%2Fapi.telegram.org%2FbotXXX%3AYYY%2FgetUpdates) 获取信息

```shell
需要关注的内容
"chat":{"id":AAA,"title":"linshi123","type":"group","all_members_are_administrators":true},
```

```shell
如果获取到的内容中不含有上面的字段
如：{"ok":true,"result":[]}
可以将机器人从群中去除，然后重新拉入群中，重试即可
```

1.4type:group 为 Tle 的组, title 对应组名,id 为组 ID

1.5测试机器人是否正常

```shell
curl -X POST "https://api.telegram.org/botXXX:YYY/sendMessage" -d "chat_id=AAA&text=my test"
                                                                               text为发送内容
```



2.配置Zabbix-in-Telegram

2.1确认zabbix_server 的配置

```shell
AlertScriptsPath=/usr/lib/zabbix/alertscripts
```

2.2clone代码，安装依赖

```shell
git clone https://github.com/ableev/Zabbix-in-Telegram.git
yum install python-pip
cd Zabbix-in-Telegram/
pip install -r requirements.txt
没有python或者python-pip自行搜索安装
```

2.3复制告警脚本至配置路径

```shell
cp zbxtg.py zbxtg_settings.example.py zbxtg_group.py /usr/lib/zabbix/alertscripts/
cd /usr/lib/zabbix/alertscripts/
mv zbxtg_settings.example.py zbxtg_settings.py
```

2.4修改 zbxtg_settings.py

```shell
tg_key = "KEY"  # telegram bot api key  即 XXX:YYY 
zbx_server = "http://youip:port/zabbix"  # zabbix server full url
zbx_api_user = "Admin"     #可以登录的用户，并且有权限
zbx_api_pass = "zabbix"
```

2.5测试脚本是否可以正常发送警告

```shell
针对个人用户
./zbxtg.py  zabbix123456  "$bingyuantin_bot" "Test message" "Hello"
             目标用户        机器人username
```

```shell
针对用户组
./zbxtg.py  linshi123  "$bingyuantin_bot" "Test message" "Hello"   --group
              组名       机器人username
```



3.配置 zabbix-server-web

3.1创建报警媒介类型Media types，3.0以上版本都需要配置

3.2创建动作action

3.3在操作Operations中，填写触发后的message

```shell
# 默认标题：{{fire}}{{fire}}{{fire}}:告警节点:{TRIGGER.NAME}
```

```shell
# 消息内容：问题详情:  {ITEM.NAME}:{ITEM.VALUE}
                  告警主机:  {HOST.NAME}
				  告警时间:  {EVENT.DATE} {EVENT.TIME}
				  告警等级:  {TRIGGER.SEVERITY}
				  告警信息:  {TRIGGER.NAME}
				  告警项目:  {TRIGGER.KEY1}
				  当前状态:  {TRIGGER.STATUS}.{ITEM.VALUE}
				  事件ID:  {EVENT.ID}
				  zbxtg:graphs
				  zbxtg:graphs_period=10800
				  zbxtq:itemid:{ITEM.ID1}
				  zbxtg:title:{HOST.HOST} - {TRIGGER.NAME}
```

3.4在恢复操作中Recovery operrations 中,填写触发后的信息message,和Details

```shell
# 默认标题：{{OK}}{{OK}}{{OK}}:恢复节点:{TRIGGER.NAME}
```

```shell
# 消息内容： 问题详情:  {ITEM.NAME}:{ITEM.VALUE}
		   恢复主机:  {HOST.NAME}
		   恢复时间:  {EVENT.DATE} {EVENT.TIME}
		   事件等级:  {TRIGGER.SEVERITY}
		   恢复项目:  {TRIGGER.KEY1}
		   当前状态:  {TRIGGER.STATUS}.{ITEM.VALUE}
		   事件ID:  {EVENT.ID}
		   zbxtg:graphs
		   zbxtg:graphs_period=10800
		   zbxtq:itemid:{ITEM.ID1}
		   zbxtg:title:{HOST.HOST} - {TRIGGER.NAME}
```

3.5配置用户User，为被告知用户组添加报警媒介Media

3.6设置出发报警，观察Telegram是否有收到报警消息















